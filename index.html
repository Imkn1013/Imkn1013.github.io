<!DOCTYPE html>
<html>
 <head>
   <meta charset="UTF-8">
   <head>
<body onKeyDown="Key(event)">
 <div id="content"></div>
 <div id="content5"></div>
 <div id="content2"></div>
 <div id="content3"></div>
 <div id="content4"></div>
<script>
  /*最上段は最終的に隠す
  ミノ回転による無限固定回避の対策
  固定後回転時の増殖バグ修正
  IミノSRS3,4段*/
  var find=function(target,box){
  ary.forEach(
   function(value,index){
    if(value==target){
     box.push(index);
    }
   }
  );
  }
  var color;
  var colorary=[];
  for(i=0;i<264;i++){
    colorary.push(0);
  }
  var towcolor=[];
  var colorturn=function(){
    for(i=0;i<4;i++){
      colorary[towcolor[i]]=color;
    }
      towcolor=[];
  }
  var next,ord,zerotow,hold2,log,two;
  var holding=false;
  var master=0;
  var held=0;
  var holdyes = false;
  var hold ="nothing";
  var times = 0;
  var message ="gameover!!";
  var message2 =`holding : ${hold}`;
  var moving = 0;
  var moving2 = 0;
  var gameover = 0;
  var toww=[];
  var ary =[];
  var zx;
 for(let i=0;i<264;i++){
   ary.push(0);
   if(i%12==0){
     ary[i]=1;
   }
   if(i>252){
     ary[i]=1;
   }
   if(i%12==11){
     ary[i]=`1<br>`;
   }
 }
  //var nowcolorary,nowcolor;
 var desin = function() {
  ary2 = [];
  ary.forEach(function(value,index) {
    if (value == 1 || value == 2 || value == 3) {

        if(colorary[index]==0){
        ary2.push(`<span class="index-${index}" style="color: black;">■</span>`);
      }
        if(colorary[index]==1){
        ary2.push(`<span class="index-${index}" style="color: aqua;">■</span>`);
      }
        if(colorary[index]==2){
        ary2.push(`<span class="index-${index}" style="color: red;">■</span>`);
      }
        if(colorary[index]==3){
        ary2.push(`<span class="index-${index}" style="color: lime;">■</span>`);
      }
        if(colorary[index]==4){
        ary2.push(`<span class="index-${index}" style="color: blue;">■</span>`);
      }
        if(colorary[index]==5){
        ary2.push(`<span class="index-${index}" style="color: orange;">■</span>`);
      }
        if(colorary[index]==6){
        ary2.push(`<span class="index-${index}" style="color: purple;">■</span>`);
      }
        if(colorary[index]==7){
        ary2.push(`<span class="index-${index}" style="color: yellow;">■</span>`);
      }

    }
    if (value == 0) {
      ary2.push(`―`);
    }
    if(value == '1<br>' ){
      ary2.push(`■<br>`)
    }
  });
}
 desin();
 document.getElementById('content').innerHTML = ary2.join("");
  document.getElementById('content3').innerHTML = message2;

  var aroundmaster=[];
  var around;
  var inaround;
  var inaroundary=[];
  var turntimes=0;
  var style=0;
  var stylepluce;
  var turning=false;
  var turn=function(slide){
  for(let j=0;j<4;j++){
          ary[toww[j]]=0;
          }
     if(ary[inaroundary[0]+master+slide]==0&&
        ary[inaroundary[1]+master+slide]==0&&
        ary[inaroundary[2]+master+slide]==0&&
        ary[inaroundary[3]+master+slide]==0){
       //console.log(slide);
         for(let j=0;j<4;j++){
          ary[inaroundary[j]+master+slide]=2;
         }
       master=master+slide;
       find(2,towcolor);
      colorturn();
      desin();
      document.getElementById('content').innerHTML = ary2.join("");
        style=(style+stylepluce)%4;
        }else{
          for(let j=0;j<4;j++){
          ary[toww[j]]=2;
        }
         turntimes=turntimes+1;
        }
  }
  var harding=false;
  var fixing=false;

  var Key = function(event){
   toww=[];
   find(2,toww);
    //console.log(toww);

   if(event.key=="ArrowUp"){
     harding=true;
     for(let k=0;k<22;k++){
       fall();
     }
     towthree();
   }
   if(event.key=="ArrowDown"){
     fall();
   }
   if(event.key=="ArrowRight"){
    moveside(1);
   }
   if(event.key=="ArrowLeft"){
    moveside(-1);
   }

   if((event.key=="z"||event.key=="x")&&turning==false&&holding==false&&fixing==false){
     turning=true;
     turntimes=0;
     aroundmaster=[];
    if(event.key=="z"){
     around=[-11,-12,-13,-1,11,12,13,1,-11,-12,0,0,0];
     stylepluce=3;
    }
    if(event.key=="x"){
     around=[-13,-12,-11,1,13,12,11,-1,-13,-12,0,0,0];
     stylepluce=1;
    }
    if(ord!=="I"&&ord!=="O"){
     for(let j=0;j<4;j++){
      aroundmaster.push(toww[j]-master);
     }
       inaroundary=[];

     aroundmaster.forEach(function(value,index) {
      inaround=around.indexOf(value);
      //console.log(inaround);
      inaroundary[index]=around[inaround+2];

  });
     //console.log(inaroundary);
     if(turntimes==0){turn(0);}
     if(turntimes==1){
       if((style+stylepluce)%4==1){
         turn(-1);
       }else
       if((style+stylepluce)%4==3){
         turn(1);
       }else
       {
         turn(stylepluce-2);
       } 
     }
     if(turntimes==2){
      if((style+stylepluce)%4==1){
         turn(-13);
       }else
       if((style+stylepluce)%4==3){
         turn(-11);
       }else
       {
         turn(stylepluce+10);
       } 
    }
     if(turntimes==3){
       if((style+stylepluce)%4==1||(style+stylepluce)%4==3){
         turn(24);
       }else
       {
         turn(-24);
       } 
     }
     if(turntimes==4){
       if((style+stylepluce)%4==1){
         turn(23);
       }else
       if((style+stylepluce)%4==3){
         turn(25);
       }else
       {
         turn(stylepluce-26);
       } 
     }
   }
    if(ord=="I"){

      if(style==1){
      inaroundary=[12,13,14,15];
      }
      if(style==2){
      inaroundary=[2,14,26,38];
      }
      if(style==3){
      inaroundary=[24,25,26,27];
      }
      if(style==0){
      inaroundary=[1,13,25,37];
      }

      if(turntimes==0){turn(0);}
     if(turntimes==1){
       if((style+stylepluce)%4==1){
         turn(1);
       }else
       if((style+stylepluce)%4==3){
         turn(-1);
       }else
       if((style+stylepluce)%4==2){
         turn(stylepluce-2);
       }else{
         turn(2*stylepluce-4);
       }
     }
     if(turntimes==2){
     if((style+stylepluce)%4==1){
         turn(-1);
       }else
       if((style+stylepluce)%4==3){
         turn(1);
       }else
       if((style+stylepluce)%4==0){
         turn(-stylepluce+2);
       }else{
         turn(-2*stylepluce+4);
       }
    }
    /*
     if(turntimes==3){
     }
     if(turntimes==4){
     }
      */
    }
     turning=false;
    // console.log(`turntimes: ${turntimes}, style: ${style}, stylepluce: ${stylepluce}`);
   }

  if(event.key==" "&&harding==false){

    holding=true;
     hold2 = hold;
     hold = ord;
     ord = hold2;
     holdyes = true;
     towzero();
     moving=0;
     message2 = `holding : ${hold}`;
    setting();
     document.getElementById('content3').innerHTML = message2;
   }

   if(event.key=="a"){
     console.log(colorary);
   }
 }

  var moveside=function(side){
   for(let i=0;i<4;i++){
      ary[toww[i]]=0;
    }
    if(ary[toww[0]+side]==0 && ary[toww[1]+side]==0 && ary[toww[2]+side]==0 && ary[toww[3]+side]==0){
     for(let i=0;i<4;i++){
      ary[toww[i]+side]=2;
    }
     master=master+side;
      find(2,towcolor);
      colorturn();
     desin();
     document.getElementById('content').innerHTML = ary2.join("");
    }else{
     for(let i=0;i<4;i++){
      ary[toww[i]]=2;
    }
    }
}
  var cleartimes=0;
 var ary3 = [1,0,0,0,0,0,0,0,0,0,0,`1<br>`];
  var pluceall = 0;
  var colorary2=colorary;
  var colorary3=[0,0,0,0,0,0,0,0,0,0,0,0];
  var clear = function(){
    //console.log("clear was done"+cleartimes);
    cleartimes++;
  for(let i=0;i<21;i++){
   pluceall = 0;
   for(let j=1;j<11;j++){
    pluceall = pluceall+ary[12*i+j];
   }
   if(pluceall==30){
     ary3 = [1,0,0,0,0,0,0,0,0,0,0,`1<br>`];
     colorary3=[0,0,0,0,0,0,0,0,0,0,0,0];
    for(let j=1;j<11;j++){
     ary[12*i+j] = 0;
    }
    for(let j=1;j<11;j++){
     colorary[12*i+j] = 0;
    }

    ary.forEach(function(value,index) {
    ary3.push(value);
     if(index<i*12+12){
       ary[index]=ary3[index];
     }
    });
     colorary.forEach(function(value,index) {
    colorary3.push(value);
     if(index<i*12+12){
       colorary[index]=colorary3[index];
     }
    });

   }
  }
  }

  var towzero = function(){

      for(let j=0;j<4;j++){
      zerotow=ary.indexOf(2);
      if(zerotow!==-1){
      ary[zerotow]=0;

      }
      }
       desin();
       document.getElementById('content').innerHTML = ary2.join("");
    }
  var towwww=[];
  var canfix=false;
  var towthree = function(){
      canfix=false;
      towwww=[];
      find(2,towwww);
      console.log(towwww);
      for(let i=0;i<4;i++){
        ary[towwww[i]]=0;
      }
      for(let i=0;i<4;i++){
        if(ary[towwww[i]+12]!==0){
          canfix=true;
        }
      }
      if(canfix==true){
        for(let i=0;i<4;i++){
        ary[towwww[i]]=3;
        }
      }else{
        for(let i=0;i<4;i++){
          ary[towwww[i]]=2;
        }
      }
      fixing=true;
       desin();
       document.getElementById('content').innerHTML = ary2.join("");}
    

 var position = [];
 var setting = function(){
    harding=false;
     if(moving2==0){
      moving=1;
       moving2=1;
     if(holdyes==false){
     ord=oder[times];
     times=times+1;
      if(gameover==0){
       makeoder();
       next=oder.slice(makeord-5,makeord);
  document.getElementById('content5').innerHTML = "next:"+next;
      }
     }
     if(holdyes==true){
       holdyes = false;
     }
      //ord = 'J' //デバッグ用
     towthree();
       clear();

       let position;
       if (ord == 'O') {
         position = [5, 6, 17, 18];
         color=7;
       } else if (ord == 'I') {
         position = [16, 17, 18, 19];
         color=1;
       } else if (ord == 'Z') {
         position = [4, 5, 17, 18];
         color=2;
       } else if (ord == 'S') {
         position = [5, 6, 17, 16];
         color=3;
       } else if (ord == 'J') {
         position = [4, 16, 17, 18];
         color=4;
       } else if (ord == 'L') {
         position = [6, 16, 17, 18];
         color=5;
       } else if (ord == 'T') {
         position = [5, 16, 17, 18];
         color=6;
}

       if (ary[position[0]] == 0 && ary[position[1]] == 0 && ary[position[2]] == 0 && ary[position[3]] == 0) {
         for (let j = 0; j < 4; j++) {
          ary[position[j]] = 2;
         }
         style=0;
         fixing=false;
         holding=false;
       } else {gameover = 1;}

       master=0;
       if(ord!=="I"){
         master=17;
       }else{
         master=4;
       }
       find(2,towcolor);
      colorturn();
     desin();
     document.getElementById('content').innerHTML = ary2.join("");
     if(gameover==1){
       document.getElementById('content4').innerHTML = message;
       clearInterval(fall);
     }
  }
 } 
  var towww = [];
var fall = function(){
  if(gameover==0){
   towww=[];
   ary.forEach(
    function(value, index) {
      if (value === 2) {
        towww.push(index);
        ary[index]=0;
      }});
   if(ary[towww[0]+12]==0 && ary[towww[1]+12]==0 && ary[towww[2]+12]==0 && ary[towww[3]+12]==0){
     moving=1;
     moving2=1;
     for(i=0;i<4;i++){
      ary[towww[i]+12]=2;
    }
     master=master+12
     find(2,towcolor);
      colorturn();
     desin();
     document.getElementById('content').innerHTML = ary2.join("");
  }else{
    for(i=0;i<4;i++){
      ary[towww[i]]=2;
    }
     held=0;
    if(moving==0){
    moving2=0;
  }
     moving = 0;
  }}}

  var oder =[];

  var mino =minof = ['I','O','Z','S','L','J','T'];
  var ran,minoran;   
 //document.getElementById('content2').innerHTML = oder;
  setInterval(fall,500);
  setTimeout(function(){setInterval(setting,500);},1)


  var makeord=0;
  var makeoder =function(){
  if(makeord%7==0){
        mino = [...minof];
     }
  ran = Math.floor(Math.random() * (7-makeord%7));
  minoran =mino[ran];
  oder.push(minoran);
  mino.splice(ran , 1 );
  // document.getElementById('content2').innerHTML = oder;
  makeord=makeord+1;
  }

for(let j=0;j<5;j++){
makeoder();
}

next=oder.slice(makeord-5,makeord);
document.getElementById('content5').innerHTML = "next:"+next;
</script>
</body>
</html>
